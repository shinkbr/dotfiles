#!/usr/bin/env ruby
# coding: utf-8

require 'uri'

def abort_with_help
  abort "Usage: #{File.basename($0)} <e|ex|d|dx>"
end

if ARGV.size != 1
  abort_with_help
end

mode = ARGV[0]
unless ['e', 'ex', 'd', 'dx'].include?(mode)
  abort_with_help
end

unsafe = ((32..126).map {|i| i.chr} - ('0'..'9').to_a - ('a'..'z').to_a - ('A'..'Z').to_a).join('')
# => " !\"\#$%&'()*+,-./:;<=>?@[\\]^_`{|}~"

STDIN.each_line do |line|
  case mode
  when 'e'
    print URI.encode(line, unsafe)
  when 'ex'
    print URI.encode(line, unsafe).gsub('%', '\x')
  when 'd'
    print URI.decode(line)
  when 'dx'
    print URI.decode(line.gsub('\x', '%'))
  end
end
